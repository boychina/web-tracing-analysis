<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>应用管理</title>
    <meta name="renderer" content="webkit" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <link rel="stylesheet" href="./admin/css/other/analysis.css" />
  </head>
  <body>
    <div class="pear-container">
      <div class="layui-row">
        <div class="layui-col-md12">
          <div class="layui-card">
            <div class="layui-card-header">
              应用管理
              <button
                class="layui-btn layui-btn-sm"
                id="app-btnAdd"
                style="float: right"
              >
                注册应用
              </button>
            </div>
            <div class="layui-card-body">
              <table class="layui-hide" id="app-table"></table>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      layui.use(["table", "layer", "form", "toast"], function () {
        var table = layui.table,
          layer = layui.layer,
          form = layui.form,
          toast = layui.toast;
        var base = "";
        var currentUser = null;
        var currentRole = null;
        var inst = table.render({
          elem: "#app-table",
          cols: [
            [
              { field: "id", title: "ID", width: 80 },
              { field: "appName", title: "应用名称" },
              { field: "appCode", title: "应用代码" },
              { field: "appCodePrefix", title: "代码前缀" },
              { field: "appDesc", title: "描述" },
              { field: "appManagers", title: "管理员", templet: function(d){
                  try { var arr = JSON.parse(d.appManagers||'[]'); if (!Array.isArray(arr)) return ''; var names = []; for (var i=0;i<arr.length;i++){ var id = arr[i]; if (window.__userCache && window.__userCache[id]) names.push(window.__userCache[id]); else names.push(String(id)); } return names.join(','); } catch(e){ return ''; }
                } },
              {
                title: "操作",
                width: 200,
                templet: function (d) {
                  var btns = '';
                  var allowEdit = false, allowDel = false;
                  if (currentRole === 'SUPER_ADMIN') { allowEdit = true; allowDel = true; }
                  else if (currentRole === 'ADMIN') {
                    try { var arr = JSON.parse(d.appManagers||'[]'); if (Array.isArray(arr)) { var uid = currentUser && currentUser.id; allowEdit = arr.indexOf(String(uid))>=0 || arr.indexOf(uid)>=0; allowDel = allowEdit; } } catch(e){}
                  }
                  if (allowEdit) btns += '<button class="layui-btn layui-btn-xs" data-app-edit="'+d.id+'">编辑</button>';
                  if (allowDel) btns += '<button class="layui-btn layui-btn-danger layui-btn-xs" data-app-del="'+d.id+'">删除</button>';
                  return btns;
                },
              },
            ],
          ],
          data: [],
          page: true,
        });

        function reload() {
          fetch(base + "/application/list")
            .then((r) => r.json())
            .then(function (resp) {
              if (resp.code === 1000) {
                inst.reload({ data: resp.data });
              }
            });
        }
        fetch('/user/me').then(r=>r.json()).then(function(resp){ if(resp.code===1000){ currentUser = { id: resp.data.id, username: resp.data.username }; currentRole = resp.data.role; } var btn = document.getElementById('btnAdd'); if (btn) { btn.style.display = (currentRole==='SUPER_ADMIN' || currentRole==='ADMIN') ? '' : 'none'; } fetch('/application/users').then(r=>r.json()).then(function(us){ if(us.code===1000){ window.__userCache = {}; var arr = us.data||[]; for (var i=0;i<arr.length;i++){ window.__userCache[String(arr[i].id)] = arr[i].username; } } reload(); }); });

        document
          .getElementById("app-btnAdd")
          .addEventListener("click", function () {
            openAppForm("注册应用", null);
          });

        document.body.addEventListener("click", function (e) {
          var editBtn =
            e.target.closest && e.target.closest("button[data-app-edit]");
          if (editBtn) {
            var id = editBtn.getAttribute("data-app-edit");
            var row = findRow(id);
            openAppForm("编辑应用", row);
            return;
          }
          var delBtn = e.target.closest && e.target.closest("button[data-app-del]");
          if (delBtn) {
            var id = delBtn.getAttribute("data-app-del");
            layer.confirm("确认删除该应用？", function (idx) {
              fetch(base + "/application/delete", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ id: Number(id) }),
              })
                .then((r) => r.json())
                .then(function (resp) {
                  if (resp.code === 1000) {
                    toast.success({ message: "删除成功" });
                    reload();
                  } else {
                    toast.error({ message: resp.msg || "删除失败" });
                  }
                });
              layer.close(idx);
            });
          }
        });

        function findRow(id) {
          var cache = layui.table.cache || {};
          var data = cache["app-table"] || [];
          for (var i = 0; i < data.length; i++) {
            if (String(data[i].id) === String(id)) return data[i];
          }
          return null;
        }

        function openAppForm(title, row) {
          var initName = row ? row.appName || "" : "";
          var initPrefix = row ? row.appCodePrefix || "" : "";
          var initDesc = row ? row.appDesc || "" : "";
          layer.open({
            title: title,
            area: ["520px", "380px"],
            btn: ['提交','取消'],
            content:
              '<div style="padding:16px;">' +
              '<div class="layui-form-item">' +
              '  <label class="layui-form-label">应用名称</label>' +
              '  <div class="layui-input-block">' +
              '    <input type="text" id="f_app_name" value="' +
              initName +
              '" placeholder="2-16字符" autocomplete="off" class="layui-input">' +
              "  </div>" +
              "</div>" +
              '<div class="layui-form-item">' +
              '  <label class="layui-form-label">代码前缀</label>' +
              '  <div class="layui-input-block">' +
              '    <input type="text" id="f_app_code_prefix" value="' +
              initPrefix +
              '" placeholder="2-16位字母数字下划线" autocomplete="off" class="layui-input">' +
              "  </div>" +
              "</div>" +
              '<div class="layui-form-item">' +
              '  <label class="layui-form-label">应用描述</label>' +
              '  <div class="layui-input-block">' +
              '    <input type="text" id="f_app_desc" value="' +
              initDesc +
              '" placeholder="(可选)" autocomplete="off" class="layui-input">' +
              "  </div>" +
              "</div>" +
              '<div class="layui-form-item">' +
              '  <label class="layui-form-label">管理员</label>' +
              '  <div class="layui-input-block" id="f_app_managers_box">' +
              '    <div id="f_app_managers_loading">加载中...</div>' +
              '  </div>' +
              '</div>' +
              "</div>",
            success: function () {
              fetch('/application/users').then(r=>r.json()).then(function(resp){
                var box = document.getElementById('f_app_managers_box');
                var loading = document.getElementById('f_app_managers_loading');
                if (loading) loading.parentNode.removeChild(loading);
                var selected = [];
                try { selected = row && row.appManagers ? JSON.parse(row.appManagers) : []; } catch(e){ selected = []; }
                if (resp.code===1000) {
                  var users = resp.data || [];
                  window.__userCache = window.__userCache || {};
                  var html = '';
                  for (var i=0;i<users.length;i++) {
                    var u = users[i]; window.__userCache[String(u.id)] = u.username;
                    var checked = selected.indexOf(String(u.id))>=0 || selected.indexOf(u.id)>=0 ? 'checked' : '';
                    html += '<input type="checkbox" name="f_app_managers" value="'+u.id+'" '+checked+' title="'+u.username+'" style="margin-right:8px;">'+u.username+'\n';
                  }
                  box.innerHTML = html;
                } else {
                  box.innerHTML = '<span style="color:#f00;">加载用户失败</span>';
                }
              });
            },
            yes: function (idx) {
              var name = document.getElementById("f_app_name").value.trim();
              var prefix = document.getElementById("f_app_code_prefix").value.trim();
              var desc = document.getElementById("f_app_desc").value.trim();
              if (name.length < 2 || name.length > 16) { toast.error({ message: "应用名称长度需2-16" }); return false; }
              if (!/^[A-Za-z0-9_]{2,16}$/.test(prefix)) { toast.error({ message: "代码前缀需2-16位字母数字下划线" }); return false; }
              var checks = document.querySelectorAll('input[name="f_app_managers"]:checked');
              var managers = []; for (var i=0;i<checks.length;i++){ managers.push(String(checks[i].value)); }
              var payload = row ? { id: row.id, app_name: name, app_code_prefix: prefix, app_desc: desc, app_managers: managers } : { app_name: name, app_code_prefix: prefix, app_desc: desc, app_managers: managers };
              var url = row ? "/application/update" : "/application/create";
              fetch(base + url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) })
                .then((r) => r.json())
                .then(function (resp) {
                  if (resp.code === 1000) {
                    toast.success({ message: "操作成功" });
                    layer.closeAll();
                    reload();
                  } else {
                    toast.error({ message: resp.msg || "操作失败" });
                  }
                });
              return false;
            },
            btn2: function (idx) { layer.close(idx); }
          });
        }
      });
    </script>
  </body>
</html>
