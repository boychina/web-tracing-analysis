<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>应用监控</title>
    <meta name="renderer" content="webkit" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <link rel="stylesheet" href="./admin/css/other/analysis.css" />
  </head>
  <body>
    <div class="pear-container">
      <div class="layui-row layui-col-space10">
        <div class="layui-col-xs12" style="padding: 8px 16px">
          <div class="layui-inline">
            <label class="layui-form-label" style="width: auto">选择应用</label>
            <form
              class="layui-form"
              lay-filter="appForm"
              style="display: inline-block"
            >
              <div class="layui-input-inline" style="width: 220px">
                <select
                  name="appSelect"
                  id="appSelect"
                  lay-filter="appSelect"
                ></select>
              </div>
            </form>
            <button
              type="button"
              id="manageBtn"
              class="layui-btn layui-bg-blue"
            >
              应用管理
            </button>
          </div>
        </div>
        <div class="layui-col-xs6 layui-col-md2">
          <div class="layui-card top-panel">
            <div class="layui-card-header">日活跃用户</div>
            <div class="layui-card-body">
              <div class="layui-row layui-col-space5">
                <div
                  id="m_user"
                  class="layui-col-xs8 layui-col-md8 top-panel-number"
                  style="color: #28333e"
                >
                  0
                </div>
                <div class="layui-col-xs4 layui-col-md4 top-panel-tips">
                  <img
                    src="./admin/images/icon_usercount.svg"
                    alt=""
                    class="icon"
                    style="margin-top: -12px; width: 50px; height: 50px"
                  />
                </div>
              </div>
            </div>
            <div
              class="layui-card-header"
              style="font-size: smaller; font-family: system-ui; color: #999"
            >
              历史用户数: <span id="app_sumUser">0</span>
            </div>
          </div>
        </div>
        <div class="layui-col-xs6 layui-col-md2">
          <div class="layui-card top-panel">
            <div class="layui-card-header">日活跃设备</div>
            <div class="layui-card-body">
              <div class="layui-row layui-col-space5">
                <div
                  id="m_device"
                  class="layui-col-xs8 layui-col-md8 top-panel-number"
                  style="color: #28333e"
                >
                  0
                </div>
                <div class="layui-col-xs4 layui-col-md4 top-panel-tips">
                  <img
                    src="./admin/images/icon_device.svg"
                    alt=""
                    class="icon"
                    style="margin-top: -12px; width: 50px; height: 50px"
                  />
                </div>
              </div>
            </div>
            <div
              class="layui-card-header"
              style="font-size: smaller; font-family: system-ui; color: #999"
            >
              历史设备数: <span id="app_sumDevices">0</span>
            </div>
          </div>
        </div>
        <div class="layui-col-xs6 layui-col-md2">
          <div class="layui-card top-panel">
            <div class="layui-card-header">日活跃会话</div>
            <div class="layui-card-body">
              <div class="layui-row layui-col-space5">
                <div
                  id="m_session"
                  class="layui-col-xs8 layui-col-md8 top-panel-number"
                  style="color: #28333e"
                >
                  0
                </div>
                <div class="layui-col-xs4 layui-col-md4 top-panel-tips">
                  <img
                    src="./admin/images/icon_session.svg"
                    alt=""
                    class="icon"
                    style="margin-top: -12px; width: 50px; height: 50px"
                  />
                </div>
              </div>
            </div>
            <div
              class="layui-card-header"
              style="font-size: smaller; font-family: system-ui; color: #999"
            >
              历史会话数: <span id="app_sumSession">0</span>
            </div>
          </div>
        </div>
        <div class="layui-col-xs6 layui-col-md2">
          <div class="layui-card top-panel">
            <div class="layui-card-header">日点击量</div>
            <div class="layui-card-body">
              <div class="layui-row layui-col-space5">
                <div
                  id="m_click"
                  class="layui-col-xs8 layui-col-md8 top-panel-number"
                  style="color: #28333e"
                >
                  0
                </div>
                <div class="layui-col-xs4 layui-col-md4 top-panel-tips">
                  <img
                    src="./admin/images/icon_click.svg"
                    alt=""
                    class="icon"
                    style="margin-top: -12px; width: 50px; height: 50px"
                  />
                </div>
              </div>
            </div>
            <div
              class="layui-card-header"
              style="font-size: smaller; font-family: system-ui; color: #999"
            >
              历史点击量: <span id="app_sumClick">0</span>
            </div>
          </div>
        </div>
        <div class="layui-col-xs6 layui-col-md2">
          <div class="layui-card top-panel">
            <div class="layui-card-header">日浏览PV</div>
            <div class="layui-card-body">
              <div class="layui-row layui-col-space5">
                <div
                  id="m_pv"
                  class="layui-col-xs8 layui-col-md8 top-panel-number"
                  style="color: #28333e"
                >
                  0
                </div>
                <div class="layui-col-xs4 layui-col-md4 top-panel-tips">
                  <img
                    src="./admin/images/icon_device.svg"
                    alt=""
                    class="icon"
                    style="margin-top: -12px; width: 50px; height: 50px"
                  />
                </div>
              </div>
            </div>
            <div
              class="layui-card-header"
              style="font-size: smaller; font-family: system-ui; color: #999"
            >
              历史浏览数: <span id="app_sumPages">0</span>
            </div>
          </div>
        </div>
        <div class="layui-col-xs6 layui-col-md2">
          <div class="layui-card top-panel">
            <div class="layui-card-header">日上报错误</div>
            <div class="layui-card-body">
              <div class="layui-row layui-col-space5">
                <div
                  id="m_error"
                  class="layui-col-xs8 layui-col-md8 top-panel-number"
                  style="color: #28333e"
                >
                  0
                </div>
                <div class="layui-col-xs4 layui-col-md4 top-panel-tips">
                  <img
                    src="./admin/images/icon_pagecount.svg"
                    alt=""
                    class="icon"
                    style="margin-top: -12px; width: 50px; height: 50px"
                  />
                </div>
              </div>
            </div>
            <div
              class="layui-card-header"
              style="font-size: smaller; font-family: system-ui; color: #999"
            >
              历史错误数: <span id="app_sumError">0</span>
            </div>
          </div>
        </div>
      </div>
      <div class="layui-row layui-col-space10" style="margin-top: 10px">
        <div class="layui-col-md12">
          <div class="layui-card">
            <div class="layui-card-header">本周访问趋势图</div>
            <div class="layui-card-body">
              <div id="weeklyChart" style="height: 360px"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="layui-row layui-col-space10" style="margin-top: 10px">
        <div class="layui-col-md12">
          <div class="layui-card">
            <div class="layui-card-header">本周各页面 PV</div>
            <div class="layui-card-body">
              <div id="weeklyPageChart" style="height: 360px"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      layui.use(
        ["layer", "echarts", "element", "count", "form", "jquery"],
        function () {
          var layer = layui.layer,
            echarts = layui.echarts,
            count = layui.count,
            form = layui.form,
            $ = layui.jquery;
          var chart = echarts.init(document.getElementById("weeklyChart"), "walden");
          var option = {
            tooltip: { trigger: "axis" },
            xAxis: { type: "category", data: [] },
            yAxis: { type: "value" },
            series: [{ name: "PV", type: "line", smooth: true, data: [] }],
          };
          chart.setOption(option);
          window.__charts = window.__charts || [];
          window.__charts.push(chart);
          window.addEventListener("resize", function () {
            try {
              (window.__charts || []).forEach(function (c) {
                if (c && c.resize) c.resize();
              });
            } catch (e) {}
          });

          function loadApps() {
            fetch("/application/list")
              .then((r) => r.json())
              .then(function (resp) {
                if (resp.code === 1000) {
                  var list = resp.data || [];
                  var sel = document.getElementById("appSelect");
                  sel.innerHTML = "";
                  for (var i = 0; i < list.length; i++) {
                    var opt = document.createElement("option");
                    opt.value = list[i].appCode;
                    opt.text = list[i].appName + "(" + list[i].appCode + ")";
                    sel.appendChild(opt);
                  }
                  if (list.length > 0) {
                    $("#appSelect").val(list[0].appCode);
                    refresh(list[0].appCode);
                  }
                  form.render("select");
                  form.on("select(appSelect)", function (data) {
                    if (data.value) {
                      refresh(data.value);
                    }
                  });
                  var btn = document.getElementById("manageBtn");
                  if (btn) {
                    btn.onclick = function () {
                      window.location.href = "/view/application/index.html";
                    };
                  }
                }
              });
          }

          function refresh(appCode) {
            fetch(
              "/application/monitor/dailyBase?appCode=" +
                encodeURIComponent(appCode)
            )
              .then((r) => r.json())
              .then(function (resp) {
                if (resp.code === 1000) {
                  var d = resp.data[0];
                  document.getElementById("m_user").innerText = d.USER_COUNT;
                  document.getElementById("m_device").innerText = d.DEVICE_NUM;
                  document.getElementById("m_session").innerText =
                    d.SESSION_UNM;
                  document.getElementById("m_click").innerText = d.CLICK_NUM;
                  document.getElementById("m_pv").innerText = d.PV_NUM;
                  document.getElementById("m_error").innerText =
                    d.ERROR_NUM || 0;
                  try {
                    count.up("m_user", {
                      time: 1200,
                      num: d.USER_COUNT,
                      bit: 0,
                      regulator: 50,
                    });
                    count.up("m_device", {
                      time: 1200,
                      num: d.DEVICE_NUM,
                      bit: 0,
                      regulator: 50,
                    });
                    count.up("m_session", {
                      time: 1200,
                      num: d.SESSION_UNM,
                      bit: 0,
                      regulator: 50,
                    });
                    count.up("m_click", {
                      time: 1200,
                      num: d.CLICK_NUM,
                      bit: 0,
                      regulator: 50,
                    });
                    count.up("m_pv", {
                      time: 1200,
                      num: d.PV_NUM,
                      bit: 0,
                      regulator: 50,
                    });
                    count.up("m_error", {
                      time: 1200,
                      num: d.ERROR_NUM || 0,
                      bit: 0,
                      regulator: 50,
                    });
                  } catch (e) {}
                }
              });
            // 历史累计指标
            fetch(
              "/application/monitor/allBase?appCode=" +
                encodeURIComponent(appCode)
            )
              .then(function (r) {
                return r.json();
              })
              .then(function (resp) {
                if (resp.code === 1000) {
                  var d = resp.data;
                  var allBaseInfo = Array.isArray(d) ? d[0] : d;
                  console.log(">>>>>>>>>allBaseInfo", allBaseInfo);
                  // {
                  //     "APPLICATION_NUM": 1,
                  //     "USER_COUNT": 4,
                  //     "DEVICE_NUM": 2,
                  //     "SESSION_UNM": 9,
                  //     "CLICK_NUM": 12,
                  //     "PV_NUM": 33,
                  //     "ERROR_NUM": 24
                  // }
                  if (allBaseInfo) {
                    document.getElementById("app_sumUser").innerText =
                      allBaseInfo.USER_COUNT || 0;
                    document.getElementById("app_sumDevices").innerText =
                      allBaseInfo.DEVICE_NUM || 0;
                    document.getElementById("app_sumSession").innerText =
                      allBaseInfo.SESSION_UNM || 0;
                    document.getElementById("app_sumClick").innerText =
                      allBaseInfo.CLICK_NUM || 0;
                    document.getElementById("app_sumPages").innerText =
                      allBaseInfo.PV_NUM || 0;
                    document.getElementById("app_sumError").innerText =
                      allBaseInfo.ERROR_NUM || 0;
                  }
                }
              });
            var dates = getRangeDate(7);
            var body = {
              appCode: appCode,
              startDate: dates[0],
              endDate: dates[dates.length - 1],
            };
            fetch("/application/monitor/dailyPV", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(body),
            })
              .then((r) => r.json())
              .then(function (resp) {
                if (resp.code === 1000) {
                  var daily = resp.data;
                  var xs = dates;
                  var ys = [];
                  for (var i = 0; i < xs.length; i++) {
                    var y = 0;
                    for (var j = 0; j < daily.length; j++) {
                      if (daily[j].DATETIME === xs[i]) {
                        y = daily[j].PV_NUM;
                        break;
                      }
                    }
                    ys.push(y);
                  }
                  chart.setOption({
                    xAxis: { data: xs },
                    series: [{ name: "PV", data: ys }],
                  });
                }
              });
            // 本周各页面 PV 聚合
            fetch(
              "/application/monitor/weeklyPagePV?appCode=" +
                encodeURIComponent(appCode)
            )
              .then(function (r) {
                return r.json();
              })
              .then(function (resp) {
                if (resp.code === 1000) {
                  var items = resp.data || [];
                  // 只取前 10 个页面，避免过多分类
                  items = items.slice(0, 10);
                  var xs = items.map(function (it) {
                    return it.PAGE_URL;
                  });
                  var ys = items.map(function (it) {
                    return it.PV_NUM;
                  });
                  var pchart = echarts.init(
                    document.getElementById("weeklyPageChart"),
                    "walden"
                  );
                  pchart.setOption({
                    tooltip: { trigger: "axis" },
                    xAxis: {
                      type: "category",
                      data: xs,
                      axisLabel: { interval: 0, rotate: 30 },
                    },
                    yAxis: { type: "value" },
                    series: [{ name: "PV", type: "bar", data: ys }],
                  });
                  try {
                    window.__charts.push(pchart);
                  } catch (e) {}
                }
              });
          }

          function getRangeDate(n) {
            var range = [];
            var today = new Date();
            for (var i = 0; i < n; i++) {
              var date = new Date(today.getTime() - i * 24 * 60 * 60 * 1000);
              var y = date.getFullYear();
              var m = ("0" + (date.getMonth() + 1)).slice(-2);
              var d = ("0" + date.getDate()).slice(-2);
              range.push(y + "-" + m + "-" + d);
            }
            return range.reverse();
          }

          loadApps();
        }
      );
    </script>
  </body>
</html>
